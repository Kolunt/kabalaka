# Изоляция календарей пользователей

## ✅ Да, система правильно учитывает, что у каждого пользователя свой календарь

### 1. Структура базы данных

**Таблица `calendar_connections`:**
- `user_id` - обязательное поле, привязывает календарь к конкретному пользователю
- `UNIQUE(user_id, calendar_type)` - гарантирует, что каждый пользователь может иметь только один календарь каждого типа (Google или Yandex)
- Все календари хранятся с привязкой к `user_id`

### 2. Методы работы с календарями

Все методы в `database.py` работают с `user_id`:

- `save_calendar_connection(user_id, ...)` - сохраняет календарь для конкретного пользователя
- `get_calendar_connection(user_id, calendar_type)` - получает календарь конкретного пользователя
- `get_user_calendars(user_id)` - получает ВСЕ календари конкретного пользователя
- `delete_calendar_connection(user_id, calendar_type)` - удаляет календарь конкретного пользователя

### 3. Проверка событий (scheduler.py)

В функции `check_and_notify_events()`:

```python
active_users = db.get_all_active_users()  # Получаем всех пользователей

for user_id in active_users:  # Для каждого пользователя отдельно
    calendars = db.get_user_calendars(user_id)  # Получаем ТОЛЬКО его календари
    
    for cal_info in calendars:
        connection = db.get_calendar_connection(user_id, calendar_type)  # Его подключение
        events = await get_events_for_calendar(connection, calendar_type)  # Его события
        await send_notification(bot, user_id, event, calendar_type)  # Уведомление ему
```

**Каждый пользователь получает уведомления только о своих событиях!**

### 4. Подключение календарей (bot.py)

При подключении календаря:

```python
user_id = update.effective_user.id  # ID пользователя из Telegram
db.save_calendar_connection(
    user_id=user_id,  # Сохраняется с привязкой к этому пользователю
    calendar_type='google',
    ...
)
```

**Каждый пользователь подключает только свой календарь!**

### 5. Получение событий из календаря

В `calendar_google.py`:
- Используется `calendarId='primary'` - это основной календарь пользователя, который авторизовался
- Credentials создаются из токена конкретного пользователя
- Каждый пользователь видит только события из своего календаря

### 6. Меню календарей

В `bot.py` функция `get_calendars_menu(user_id)`:
- Получает календари только для конкретного `user_id`
- Каждый пользователь видит только свои календари

## Итог

✅ **Каждый пользователь:**
- Подключает только свой календарь
- Видит только свои календари в меню
- Получает уведомления только о своих событиях
- Не может видеть или изменять календари других пользователей

✅ **Изоляция гарантируется на уровне:**
- Базы данных (UNIQUE constraint)
- Логики приложения (все методы работают с user_id)
- OAuth токенов (каждый пользователь авторизуется отдельно)

Система полностью изолирует календари по пользователям!

