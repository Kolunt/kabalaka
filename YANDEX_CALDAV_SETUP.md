# Настройка Yandex Calendar через CalDAV

## Реализация

Реализована поддержка получения событий из Yandex Calendar через протокол CalDAV.

## Как это работает

1. **CalDAV запрос**: Используется стандартный CalDAV REPORT запрос с фильтром по времени
2. **OAuth авторизация**: Используется Bearer токен из OAuth авторизации
3. **Парсинг iCalendar**: События парсятся из формата iCalendar (ICS)
4. **Множественные endpoints**: Система пробует несколько возможных endpoints Yandex CalDAV

## Зависимости

Добавлены новые зависимости в `requirements.txt`:
- `caldav==1.3.7` - библиотека для работы с CalDAV (резервный метод)
- `python-dateutil==2.8.2` - для парсинга дат в различных форматах

## Установка зависимостей

На локальном сервере:
```bash
pip install -r requirements.txt
```

На PythonAnywhere:
```bash
pip3.10 install --user caldav python-dateutil
```

## Особенности реализации

### Основной метод (через requests)

Используется прямой HTTP запрос с методом REPORT:
- Endpoint: `https://caldav.yandex.ru/events/` (и альтернативные)
- Авторизация: `Bearer {access_token}`
- Формат запроса: XML CalDAV query
- Формат ответа: iCalendar (ICS)

### Парсинг событий

Парсится формат iCalendar:
- **UID** - уникальный идентификатор события
- **SUMMARY** - название события
- **DESCRIPTION** - описание
- **LOCATION** - место проведения
- **DTSTART** - время начала
- **DTEND** - время окончания

### Обработка ошибок

Система пробует несколько endpoints:
1. `https://caldav.yandex.ru/events/`
2. `https://caldav.yandex.ru/calendars/`
3. `https://caldav.yandex.ru/`

При ошибке пробуется альтернативный метод (через библиотеку caldav).

## Возможные проблемы

### 1. Ошибка 401 (Unauthorized)

**Причина**: OAuth токен не подходит для CalDAV, или Yandex требует другой тип авторизации.

**Решение**: 
- Yandex CalDAV может требовать не OAuth токен, а логин/пароль или пароль приложения
- Проверьте, что токен действителен
- Возможно, нужно переподключить календарь

### 2. Ошибка 404 (Not Found)

**Причина**: Неправильный endpoint или календарь не найден.

**Решение**: 
- Система автоматически пробует альтернативные endpoints
- Проверьте, что календарь существует в Yandex

### 3. Пустой ответ (0 событий)

**Причина**: 
- В календаре нет событий в указанном диапазоне
- Проблема с парсингом iCalendar формата
- Неправильный формат дат в запросе

**Решение**:
- Проверьте логи на наличие ошибок парсинга
- Убедитесь, что в календаре есть события
- Проверьте диапазон дат (time_min, time_max)

### 4. Проблемы с парсингом дат

**Причина**: Различные форматы дат в iCalendar.

**Решение**: 
- Система поддерживает несколько форматов:
  - `YYYYMMDDTHHMMSS` (локальное время)
  - `YYYYMMDDTHHMMSSZ` (UTC)
  - `YYYYMMDD` (только дата)
- Используется `python-dateutil` для сложных случаев

## Логирование

В логах вы увидите:
```
Yandex CalDAV: запрос событий с 20251125T023000Z по 20251126T023000Z
Yandex CalDAV: получено X событий
```

При ошибках:
```
Yandex CalDAV: ошибка авторизации (401)
Yandex CalDAV: календарь не найден (404)
Yandex CalDAV: неожиданный статус XXX
```

## Тестирование

Для тестирования:

1. Убедитесь, что календарь подключен через бота
2. Создайте тестовое событие в Yandex Calendar
3. Вызовите `/test/check-events` в админ-панели
4. Проверьте логи - должны увидеть:
   ```
   Yandex CalDAV: запрос событий...
   Yandex CalDAV: получено X событий
   ```

## Альтернативные методы

Если стандартный CalDAV не работает, система пробует:

1. **Альтернативные endpoints** - автоматически
2. **Библиотека caldav** - если установлена (требует дополнительной настройки)

## Ограничения

- Yandex CalDAV может иметь ограничения по частоте запросов
- Некоторые функции Yandex Calendar могут быть недоступны через CalDAV
- Формат ответа может отличаться в зависимости от версии CalDAV сервера Yandex

## Дополнительная информация

- [CalDAV RFC 4791](https://tools.ietf.org/html/rfc4791)
- [iCalendar RFC 5545](https://tools.ietf.org/html/rfc5545)
- [Yandex OAuth Documentation](https://yandex.ru/dev/id/doc/ru/)

## Отладка

Для детальной отладки включите DEBUG логирование:

```python
import logging
logging.getLogger('calendar_yandex').setLevel(logging.DEBUG)
```

Это покажет:
- Какие endpoints пробуются
- Детали запросов и ответов
- Процесс парсинга событий



