# Настройка Yandex OAuth для Kabalaka

## Пошаговая инструкция

### Шаг 1: Создание приложения в Yandex OAuth

1. Перейдите на [Yandex OAuth](https://oauth.yandex.ru/)
2. Войдите в свой аккаунт Yandex
3. Нажмите **"Создать новое приложение"** или **"Зарегистрировать новое приложение"**
4. Заполните форму:
   - **Название приложения**: Kabalaka (или любое другое)
   - **Описание**: Telegram bot for calendar notifications
   - **Платформы**: выберите **"Веб-сервисы"**
   - **Callback URI #1**: 
     - Для локальной разработки: `http://localhost:5000/callback/yandex`
     - Для PythonAnywhere: `https://yourusername.pythonanywhere.com/callback/yandex`
   - **Права доступа**: выберите **"Доступ к календарю"** или **"caldav:read"**
5. Нажмите **"Создать приложение"**

### Шаг 2: Получение Client ID и Client Secret

1. После создания приложения вы увидите:
   - **ID приложения** (Client ID) - это строка из цифр и букв
   - **Пароль приложения** (Client Secret) - секретный ключ
2. **Скопируйте оба значения** - они понадобятся для настройки

⚠️ **Важно**: 
- Client Secret показывается только один раз при создании приложения
- Если вы его не сохранили, нужно будет создать новое приложение или сбросить пароль

### Шаг 3: Настройка Callback URI

1. В настройках приложения найдите раздел **"Callback URI"** или **"URI перенаправления"**
2. Добавьте URI для вашего окружения:
   
   **Для локальной разработки:**
   ```
   http://localhost:5000/callback/yandex
   ```
   
   **Для PythonAnywhere:**
   ```
   https://yourusername.pythonanywhere.com/callback/yandex
   ```
   (замените `yourusername` на ваш реальный username)

3. Сохраните изменения

### Шаг 4: Настройка в проекте

#### Вариант 1: Настройка через админ-панель (рекомендуется)

1. Запустите Flask приложение
2. Откройте админ-панель: `http://localhost:5000/admin/login` (или `https://yourusername.pythonanywhere.com/admin/login`)
3. Войдите в систему
4. Перейдите в **Настройки** → **Основные настройки**
5. Заполните поля:
   - **Yandex Client ID**: вставьте ID приложения
   - **Yandex Client Secret**: вставьте пароль приложения
   - **Yandex Redirect URI**: 
     - Для локальной разработки: `http://localhost:5000/callback/yandex`
     - Для PythonAnywhere: `https://yourusername.pythonanywhere.com/callback/yandex`
6. Нажмите **Сохранить**

#### Вариант 2: Настройка через .env файл

1. Откройте файл `.env` в корне проекта
2. Добавьте или обновите следующие строки:
   ```env
   YANDEX_CLIENT_ID=ваш_client_id_здесь
   YANDEX_CLIENT_SECRET=ваш_client_secret_здесь
   YANDEX_REDIRECT_URI=http://localhost:5000/callback/yandex
   ```
   (для PythonAnywhere используйте `https://yourusername.pythonanywhere.com/callback/yandex`)

3. Сохраните файл

⚠️ **Примечание**: Настройки в админ-панели имеют приоритет над `.env` файлом.

### Шаг 5: Проверка подключения

1. Перезапустите Flask сервер (если он запущен)
2. Откройте Telegram бота [@KabalakaBot](https://t.me/KabalakaBot)
3. Нажмите кнопку подключения Yandex Calendar
4. Должна открыться страница авторизации Yandex
5. Разрешите доступ к календарю
6. После успешной авторизации вы получите сообщение в боте

## Важные замечания

- **Callback URI должен точно совпадать** с тем, что указано в настройках приложения Yandex
- Для локальной разработки используйте `http://localhost:5000/callback/yandex`
- Для продакшена на PythonAnywhere используйте `https://yourusername.pythonanywhere.com/callback/yandex`
- Client ID и Client Secret должны быть из одного и того же приложения
- Yandex Calendar использует CalDAV протокол для работы с календарем
- Права доступа: требуется `caldav:read` для чтения событий календаря

## Решение проблем

### Ошибка "invalid_client"

**Причины:**
- Неправильный Client ID или Client Secret
- Лишние пробелы в настройках
- Неверный формат данных

**Решение:**
1. Проверьте, что Client ID и Client Secret скопированы правильно
2. Убедитесь, что нет лишних пробелов в админ-панели или `.env` файле
3. Проверьте, что используете правильные credentials из одного приложения

### Ошибка "redirect_uri_mismatch"

**Причины:**
- Callback URI в настройках Yandex не совпадает с указанным в проекте
- Неправильный порт или протокол (http vs https)

**Решение:**
1. Убедитесь, что Callback URI в Yandex OAuth точно совпадает с тем, что в админ-панели или `.env`
2. Проверьте протокол:
   - Для локальной разработки: `http://`
   - Для PythonAnywhere: `https://`
3. Проверьте порт (для локальной разработки обычно `5000`)

### Ошибка "access_denied"

**Причины:**
- Пользователь отменил авторизацию
- Недостаточно прав доступа у приложения

**Решение:**
1. Убедитесь, что в настройках приложения Yandex выбраны права **"Доступ к календарю"** или **"caldav:read"**
2. Попросите пользователя попробовать снова и разрешить доступ

### Ошибка "invalid_grant"

**Причины:**
- Код авторизации истек (коды действительны ограниченное время)
- Код уже был использован

**Решение:**
1. Попросите пользователя начать процесс авторизации заново
2. Убедитесь, что процесс авторизации завершается быстро

### События не отображаются

**Причины:**
- Проблемы с CalDAV протоколом
- Недостаточно прав доступа

**Решение:**
1. Проверьте, что приложение имеет права `caldav:read`
2. Убедитесь, что токен не истек (токены автоматически обновляются)
3. Проверьте логи приложения на наличие ошибок

## Дополнительная информация

### Yandex OAuth Scopes

Для работы с календарем требуется scope:
- `caldav:read` - чтение календаря

### Обновление токенов

Токены Yandex автоматически обновляются при истечении срока действия. Система сама обрабатывает обновление через `refresh_token`.

### Проверка настроек

Чтобы проверить, что настройки применены правильно:
1. Откройте админ-панель
2. Перейдите в **Настройки** → **Основные настройки**
3. Проверьте, что все поля Yandex заполнены
4. Убедитесь, что Redirect URI совпадает с настройками в Yandex OAuth

## Полезные ссылки

- [Yandex OAuth](https://oauth.yandex.ru/) - создание и управление приложениями
- [Документация Yandex OAuth](https://yandex.ru/dev/id/doc/ru/) - официальная документация
- [CalDAV протокол](https://ru.wikipedia.org/wiki/CalDAV) - информация о протоколе календаря

