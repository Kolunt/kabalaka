# Диагностика проблем с уведомлениями

Если уведомления о событиях календаря не приходят в Telegram, выполните следующие шаги:

## 1. Проверка настроек в Telegram боте

1. Откройте бота в Telegram
2. Перейдите в **Настройки** (Settings)
3. Убедитесь, что:
   - ✅ Уведомления **включены** (enabled)
   - ✅ Интервал уведомлений установлен правильно (например, 5 минут)

## 2. Проверка подключения календарей

1. В боте перейдите в **Календари** (Calendars)
2. Убедитесь, что календари подключены:
   - Google Calendar должен быть в списке
   - Yandex Calendar должен быть в списке

## 3. Проверка событий в календарях

Убедитесь, что в ваших календарях есть события:
- Создайте тестовое событие на ближайшее время (например, через 10 минут)
- Убедитесь, что событие сохранено в календаре

## 4. Проверка работы cron

### На PythonAnywhere:

1. Откройте админ-панель: `https://yourusername.pythonanywhere.com/admin/settings/general`
2. Проверьте логи в разделе **Web** → **Error log** на PythonAnywhere

### На локальном сервере:

1. Откройте в браузере: `http://localhost:5000/test/check-events`
2. Проверьте вывод в терминале, где запущен `app.py`
3. Должны появиться логи вида:
   ```
   === Начало проверки событий ===
   Найдено активных пользователей: 1
   Обработка пользователя 123456789
   Интервал уведомлений для пользователя 123456789: 5 минут
   Найдено календарей для пользователя 123456789: 2
   Получено событий из google для пользователя 123456789: 3
   ...
   ```

## 5. Проверка cron-job.org

1. Откройте [cron-job.org](https://console.cron-job.org/)
2. Проверьте, что задача настроена правильно:
   - **URL**: `https://yourusername.pythonanywhere.com/cron/check-events`
   - **Schedule**: каждые 5 минут (или чаще)
   - **Status**: Active (активна)
3. Проверьте историю выполнения:
   - Нажмите на задачу
   - Посмотрите "Execution history"
   - Убедитесь, что последние выполнения были успешными (Status: OK)

## 6. Проверка времени события

**Важно**: Уведомление придет только если:
- Событие начинается **в ближайшие N минут** (где N - ваш интервал уведомлений)
- Например, если интервал 5 минут, событие должно начаться через 0-5 минут от текущего времени

**Пример:**
- Текущее время: 14:00
- Интервал уведомлений: 5 минут
- Событие в 14:03 → ✅ Уведомление придет
- Событие в 14:10 → ❌ Уведомление не придет (слишком далеко)

## 7. Проверка, не было ли уже отправлено уведомление

Система не отправляет повторные уведомления об одном и том же событии. Если уведомление уже было отправлено ранее, оно не будет отправлено снова.

## 8. Ручная проверка через тестовый endpoint

Для локальной отладки:

1. Откройте: `http://localhost:5000/test/check-events`
2. Проверьте логи в терминале
3. Должны увидеть детальную информацию о:
   - Количестве активных пользователей
   - Количестве календарей
   - Количестве найденных событий
   - Какие события попадают в диапазон уведомлений
   - Были ли отправлены уведомления

## 9. Проверка токена бота

1. Откройте админ-панель: `http://localhost:5000/admin/settings/bot`
2. Нажмите **"Проверить подключение"**
3. Убедитесь, что статус: **"Подключен"**

## 10. Типичные проблемы

### Проблема: "Найдено активных пользователей: 0"
**Решение**: Убедитесь, что календари подключены через бота

### Проблема: "Получено событий: 0"
**Решение**: 
- Проверьте, что в календаре есть события
- Проверьте, что токены доступа не истекли (переподключите календари)

### Проблема: "Событие не попадает в диапазон"
**Решение**: 
- Создайте событие на ближайшее время (в пределах интервала уведомлений)
- Проверьте часовой пояс (система использует UTC)

### Проблема: "Уведомление уже отправлено ранее"
**Решение**: Это нормально. Создайте новое событие для теста

## 11. Создание тестового события

Для проверки работы системы:

1. Откройте Google Calendar или Yandex Calendar
2. Создайте событие:
   - **Название**: "Тест уведомления"
   - **Время**: через 6-7 минут от текущего времени
   - **Описание**: (опционально)
3. Сохраните событие
4. Подождите, пока cron вызовет `/cron/check-events` (или вызовите вручную через `/test/check-events`)
5. Проверьте Telegram - должно прийти уведомление

## 12. Проверка логов на PythonAnywhere

Если используете PythonAnywhere:

1. Откройте раздел **Web**
2. Перейдите в **Error log**
3. Найдите записи с префиксом `=== Начало проверки событий ===`
4. Проверьте, есть ли ошибки или предупреждения

## 13. Контакты для помощи

Если проблема не решена:
1. Проверьте все шаги выше
2. Сохраните логи из терминала или Error log
3. Проверьте, что все настройки заполнены в админ-панели

