# Переподключение Google Calendar после включения API

## Проблема

После включения Google Calendar API в Google Cloud Console уведомления все еще не работают.

## Причина

После включения API или изменения настроек OAuth может потребоваться **переподключить календарь**, чтобы получить новые токены с правильными правами доступа.

## Решение: Переподключение календаря

### Шаг 1: Отключите старый календарь

1. Откройте Telegram бота
2. Перейдите в **Календари** (Calendars)
3. Найдите Google Calendar в списке
4. Нажмите кнопку **"Отключить Google"** (Disconnect Google)

### Шаг 2: Подключите календарь заново

1. В том же меню нажмите **"Подключить Google"** (Connect Google)
2. Откроется окно авторизации Google
3. Выберите ваш аккаунт Google
4. **Важно**: Убедитесь, что вы видите запрос на доступ к календарю
5. Нажмите **"Разрешить"** (Allow)
6. Дождитесь сообщения об успешном подключении

### Шаг 3: Проверьте работу

1. Создайте тестовое событие в Google Calendar:
   - Название: "Тест уведомления"
   - Время: через 6-7 минут от текущего времени
2. Подождите следующего запуска cron (или вызовите `/test/check-events`)
3. Проверьте логи - должны увидеть:
   ```
   Google Calendar: успешно получено X событий
   ```

## Проверка настроек Google Cloud Console

Убедитесь, что все настроено правильно:

### 1. Google Calendar API включен

1. Откройте [Google Cloud Console](https://console.cloud.google.com/)
2. Выберите ваш проект
3. **APIs & Services** → **Library**
4. Найдите "Google Calendar API"
5. Убедитесь, что статус: **"Enabled"** (Включен)

### 2. OAuth Consent Screen настроен

1. **APIs & Services** → **OAuth consent screen**
2. Проверьте:
   - **User Type**: External (или Internal)
   - **App name**: указано
   - **Scopes**: должен быть `https://www.googleapis.com/auth/calendar.readonly`
   - **Test users**: добавлен ваш email (если приложение в режиме тестирования)

### 3. OAuth 2.0 Client ID правильный

1. **APIs & Services** → **Credentials**
2. Откройте ваш OAuth 2.0 Client ID
3. Проверьте:
   - **Application type**: Web application
   - **Authorized redirect URIs**: должен быть ваш callback URL
     - Для локального: `http://localhost:5000/callback/google`
     - Для PythonAnywhere: `https://yourusername.pythonanywhere.com/callback/google`

### 4. Client ID и Secret в админ-панели

1. Откройте админ-панель: `http://localhost:5000/admin/settings/general`
2. Проверьте, что **Google Client ID** и **Google Client Secret** заполнены
3. Убедитесь, что они совпадают с теми, что в Google Cloud Console

## Диагностика через логи

После переподключения проверьте логи. Должны увидеть:

### ✅ Успешный случай:
```
Google Calendar: получение событий для пользователя 354932588
Google Calendar: успешно получено 3 событий
```

### ❌ Ошибка 403 "accessNotConfigured":
```
Google Calendar: HttpError 403: accessNotConfigured
Google Calendar: API не включен или OAuth не настроен правильно
```
**Решение**: Проверьте, что Google Calendar API включен

### ❌ Ошибка авторизации:
```
Google Calendar: ошибка при обновлении токена
Google Calendar: возможно, нужно переподключить календарь
```
**Решение**: Переподключите календарь (см. Шаг 1-2 выше)

### ❌ Нет refresh_token:
```
Google Calendar: токен истек и нет refresh_token. Нужно переподключить календарь.
```
**Решение**: Переподключите календарь (см. Шаг 1-2 выше)

## Частые проблемы

### Проблема: После переподключения все еще ошибка 403

**Решение**:
1. Убедитесь, что Google Calendar API действительно включен (может потребоваться несколько минут)
2. Проверьте, что используете правильный проект в Google Cloud Console
3. Убедитесь, что OAuth Client ID из админ-панели совпадает с тем, что в Google Cloud Console
4. Попробуйте создать новый OAuth Client ID в Google Cloud Console и обновить его в админ-панели

### Проблема: При авторизации не запрашивается доступ к календарю

**Решение**:
1. Проверьте OAuth Consent Screen - должен быть добавлен scope `calendar.readonly`
2. Убедитесь, что приложение не в режиме "Testing" без вашего email в Test users
3. Попробуйте опубликовать приложение (если возможно)

### Проблема: Токен не обновляется

**Решение**:
1. При авторизации убедитесь, что вы нажали "Разрешить" на все запросы
2. Переподключите календарь заново
3. Проверьте, что в базе данных сохранился `refresh_token`

## Проверка через тестовый endpoint

После переподключения проверьте работу:

1. Откройте: `http://localhost:5000/test/check-events` (или на PythonAnywhere)
2. Проверьте логи в терминале или Error log
3. Должны увидеть детальную информацию о получении событий

## Если ничего не помогает

1. **Создайте новый OAuth приложение**:
   - В Google Cloud Console создайте новый OAuth 2.0 Client ID
   - Обновите Client ID и Secret в админ-панели
   - Переподключите календарь

2. **Проверьте логи детально**:
   - Включите DEBUG логирование
   - Проверьте все сообщения об ошибках

3. **Убедитесь в правильности настроек**:
   - Client ID и Secret правильные
   - Redirect URI совпадает
   - API включен
   - OAuth Consent Screen настроен

